---
title: "Your Title"
format: html
execute:
    kernel: python3
---






## K-Mean Clustering

```{python}
from pyspark.sql import SparkSession
import pandas as pd
from pyspark.sql import functions as F
from pyspark.sql.types import StringType
from pyspark.ml.feature import StringIndexer, VectorAssembler, StandardScaler
from pyspark.ml.clustering import KMeans
from pyspark.ml import Pipeline
import matplotlib.pyplot as plt
import seaborn as sns
```

```{python}
# Initialize Spark Session
spark = SparkSession.builder.appName("./data/LightcastData").getOrCreate()

df = spark.read.option("header", "true") \
            .option("inferSchema", "true") \
            .option("multiLine", "true") \
            .option("escape", "\"") \
            .csv("./data/lightcast_job_postings.csv")
```

```{python}
def label_ai_roles(title):
    ai_keywords = ["AI", "artificial intelligence", "machine learning", 
                "data scientist", "deep learning"]
    title_lower = str(title).lower() if title else ''
    return "AI" if any(keyword in title_lower for keyword in ai_keywords) else "Non-AI"


label_ai_udf = F.udf(label_ai_roles, StringType())

df = df.withColumn('ai_label', label_ai_udf("TITLE_RAW"))
```

```{python}
df.printSchema()
```

```{python}

df = df.select("TITLE_RAW", "SALARY", "LIGHTCAST_SECTORS", "NAICS_2022_6", "ai_label")


```

```{python}
indexers = [
    StringIndexer(inputCol="TITLE_RAW", outputCol="job_title_enc", handleInvalid="keep"),
    StringIndexer(inputCol="LIGHTCAST_SECTORS", outputCol="industry_enc", handleInvalid="keep"),
    StringIndexer(inputCol="NAICS_2022_6", outputCol="naics_enc", handleInvalid="keep"),
    StringIndexer(inputCol="ai_label", outputCol="ai_enc", handleInvalid="keep")
]

pipeline = Pipeline(stages=indexers)
df_indexed = pipeline.fit(df).transform(df)

print("Categorical variables encoded to numbers")

```



```{python}

df_indexed_clean = df_indexed.na.drop(subset=["job_title_enc", "SALARY", "industry_enc", "naics_enc"])

```


```{python}
assembler = VectorAssembler(
    inputCols=["job_title_enc", "industry_enc", "SALARY", "naics_enc"],
    outputCol="features"
)
df_features = assembler.transform(df_indexed_clean)
```

```{python}
scaler = StandardScaler(inputCol="features", outputCol="scaled_features")
scaler_model = scaler.fit(df_features)
df_scaled = scaler_model.transform(df_features)

```

```{python}
import numpy as np 
import matplotlib.pyplot as plt
from sklearn.cluster import KMeans

X_scaled = np.array(df_scaled.select("scaled_features").toPandas()
["scaled_features"].tolist()
)

inertias = []
for k in range (2,11):
    kmeans = KMeans(n_clusters=k, random_state=42, n_init=10)
    kmeans.fit(X_scaled)
    inertias.append(kmeans.inertia_)


plt.figure(figsize=(8,5))
plt.plot(range(2,11), inertias, "bo-", linewidth=2)
plt.xlabel("Number of Clusters(K)")
plt.ylabel("Inertia")
plt.title("Elbow Method for Optimal K")
plt.grid(True)
plt.show()
```

```{python}
kmeans = KMeans(featuresCol="scaled_features", predictionCol="cluster", k=5, seed=42)
model = kmeans.fit(df_scaled)
df_clustered = model.transform(df_scaled)



```

```{python}
df_clean = df_clustered.select("cluster", "SALARY", "ai_label", "TITLE_RAW", "LIGHTCAST_SECTORS")
```



```{python}
##Salary Comparison
print("\n" + "="*80)
print("1. SALARY COMPARISON")
print("="*80)

salary_comparison = df_clean.groupBy("ai_label").agg(
    F.mean("SALARY").alias("mean"),
    F.expr("percentile_approx(SALARY, 0.5)").alias("median"),
    F.stddev("SALARY").alias("std"),
    F.count("SALARY").alias("count")
)

salary_comparison.show()


ai_salary = salary_comparison.filter(F.col("ai_label") == "AI").select("mean").collect()[0][0]
non_ai_salary = salary_comparison.filter(F.col("ai_label") == "Non-AI").select("mean").collect()[0][0]
salary_diff = ai_salary - non_ai_salary

print("\nAI roles pay $" + str(round(salary_diff, 2)) + " more on average")
```

```{python}
##Job Title Comparison
print("\n" + "="*80)
print("2. TOP JOB TITLES")
print("="*80)

print("\nTop 10 Non-AI Job Titles:")
(df_clean.filter(F.col("ai_label") == "Non-AI")
    .groupBy("TITLE_RAW")
    .count()
    .orderBy(F.desc("count"))
    .show(10, truncate=False))

print("\nTop 10 AI Job Titles:")
(df_clean.filter(F.col("ai_label") == "AI")
    .groupBy("TITLE_RAW")
    .count()
    .orderBy(F.desc("count"))
    .show(10, truncate=False))
```

```{python}
##Cluster Distribution
print("\n" + "="*80)
print("3. CLUSTER DISTRIBUTION BY AI LABEL")
print("="*80)

cluster_dist = (df_clean.groupBy("cluster", "ai_label")
        .count()
        .orderBy("cluster", "ai_label")
)
cluster_dist.show()



```

```{python}
##Industry Comparison
print("\n" + "="*80)
print("4. Industry Comparison")
print("="*80)

print("\nTop 10 Non-AI Industries:")
(df_clean.filter(F.col("ai_label") == "Non-AI")
        .groupBy("LIGHTCAST_SECTORS")
        .count()
        .orderBy(F.desc("count"))
        .show(10, truncate = False)
)

print("\nTop 10 AI Industries:")
(df_clean.filter(F.col("ai_label") == "AI")
        .groupBy("LIGHTCAST_SECTORS")
        .count()
        .orderBy(F.desc("count"))
        .show(10, truncate = False)
)
```

```{python}
##Salary by Industry
print("\n" + "="*80)
print("5. AVERAGE SALARY BY INDUSTRY (Top 10)")
print("="*80)

print("\nNon-AI Roles - Top 10 Industries by Average Salary:")
(df_clean.filter(F.col("ai_label")=="Non-AI")
        .groupBy("LIGHTCAST_SECTORS")
        .agg(F.mean("SALARY").alias("avg_salary"), F.count("SALARY").alias("job_count") )
        .filter(F.col("job_count")>=10)
        .orderBy(F.desc("avg_salary"))
        .show(10,truncate=False)   
)

print("\nAI Roles - Top 10 Industries by Average Salary:")
(df_clean.filter(F.col("ai_label")=="AI")
        .groupBy("LIGHTCAST_SECTORS")
        .agg(F.mean("SALARY").alias("avg_salary"), F.count("SALARY").alias("job_count") )
        .filter(F.col("job_count")>=10)
        .orderBy(F.desc("avg_salary"))
        .show(10,truncate=False)   
)


```

```{python}
df_pandas=df_clean.toPandas()

```

```{python}

import matplotlib.pyplot as plt
import seaborn as sns
plt.figure(figsize=(8,5))
sns.boxplot(data=df_pandas, x="cluster", y="SALARY", hue="ai_label")
plt.title("Salary Distribution by Cluster and AI Label")
plt.xlabel("Cluster")
plt.ylabel("Salary")
plt.legend(title="AI Label")
plt.show()


```

```{python}




```

```{python}



```


